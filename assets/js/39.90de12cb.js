(window.webpackJsonp=window.webpackJsonp||[]).push([[39],{824:function(s,t,n){"use strict";n.r(t);var a=n(112),e=Object(a.a)({},(function(){var s=this,t=s.$createElement,n=s._self._c||t;return n("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[n("h1",[s._v("NodeJS 事件循环")]),s._v(" "),n("h2",{attrs:{id:"nodejs-运行机制"}},[s._v("NodeJS 运行机制 "),n("a",{staticClass:"header-anchor",attrs:{href:"#nodejs-运行机制"}},[s._v("#")])]),s._v(" "),n("p",[n("img",{attrs:{src:"node.png",alt:"node"}}),s._v("\n这个图就是整个 NodeJS 的运行原理，从左到右，从上到下，NodeJS 被分为了 4 层：")]),s._v(" "),n("ol",[n("li",[s._v("应用层：JavaScript 交互层，用户代码、NodeJS 模块等，这些代码会交给 V8 引擎处理；")]),s._v(" "),n("li",[s._v("V8 引擎层：解析应用层的 JavaScript 代码，和下层交互；")]),s._v(" "),n("li",[s._v("Node API 层：Node 内建（底层）模块或三方插件，一般用 C 或 C++ 实现，和操作系统交互；")]),s._v(" "),n("li",[s._v("LIBUV 层：跨平台的底层封装，实现了事件循环、文件操作等，是异步 IO 的核心。")])]),s._v(" "),n("h2",{attrs:{id:"libuv-架构"}},[s._v("libuv 架构 "),n("a",{staticClass:"header-anchor",attrs:{href:"#libuv-架构"}},[s._v("#")])]),s._v(" "),n("p",[n("img",{attrs:{src:"libuv.png",alt:"libuv"}}),s._v("\nnodejs 实现异步机制的核心便是 libuv，libuv 承担着 nodejs 与文件、网络等异步任务的沟通桥梁。nodejs 中的异步事件有：")]),s._v(" "),n("ul",[n("li",[s._v("非 I/O：\n"),n("ul",[n("li",[s._v("定时器（setTimeout、setInterval）")]),s._v(" "),n("li",[s._v("microtask（promise）")]),s._v(" "),n("li",[s._v("process.nextTick")]),s._v(" "),n("li",[s._v("setImmediate")])])]),s._v(" "),n("li",[s._v("I/O:\n"),n("ul",[n("li",[s._v("网络 I/O")]),s._v(" "),n("li",[s._v("文件 I/O")])])]),s._v(" "),n("li",[s._v("...")])]),s._v(" "),n("h2",{attrs:{id:"异步-i-o"}},[s._v("异步 I/O "),n("a",{staticClass:"header-anchor",attrs:{href:"#异步-i-o"}},[s._v("#")])]),s._v(" "),n("p",[s._v("NodeJS 采用线程池来模拟异步 I/O。\nlibuv内部维护着一个默认4个线程的线程池，这些线程负责执行文件I/O操作、DNS操作、用户异步代码。当 js 层传递给 libuv 一个操作任务时，libuv 会把这个任务加到队列中。之后分两种情况：")]),s._v(" "),n("ul",[n("li",[s._v("线程池中的线程都被占用的时候，队列中任务就要进行排队等待空闲线程。")]),s._v(" "),n("li",[s._v("线程池中有可用线程时，从队列中取出这个任务执行，执行完毕后，线程归还到线程池，等待下个任务。同时以事件的方式通知event-loop，event-loop接收到事件执行该事件注册的回调函数。")])]),s._v(" "),n("blockquote",[n("p",[s._v("当然，如果觉得4个线程不够用，可以在nodejs启动时，设置环境变量UV_THREADPOOL_SIZE来调整，出于系统性能考虑，libuv 规定可设置线程数不能超过128个。")])]),s._v(" "),n("p",[s._v("完成整个异步 I/O 环节有事件循环、观察者和请求对象。")]),s._v(" "),n("p",[n("img",{attrs:{src:"node-io.png",alt:"node-io"}})]),s._v(" "),n("p",[n("strong",[s._v("事件循环")])]),s._v(" "),n("p",[s._v("在进程启动时，node会创建一个主循环，用于询问是否有待处理事件以及处理每一个异步事件后续的回调。每执行一次循环体的过程称为Tick。如果有待处理事件及相关回调，则取出事件并执行对应回调。如下图是事件循环模型：")]),s._v(" "),n("p",[n("strong",[s._v("观察者")])]),s._v(" "),n("p",[s._v("事件循环中正是通过观察者判断是否有事件需要处理。每个事件循环可以有一个或多个观察者，每个观察者可能对应多个事件。")]),s._v(" "),n("p",[n("strong",[s._v("请求对象")])]),s._v(" "),n("p",[s._v("在调用异步I/O后，到I/O操作完成并执行对应回调的过程中，存在一个中间产物——请求对象。它是一个状态集，保存了当前异步I/O的所有状态。以fs.readFile()为例，该方法调用Node的核心模块，进而调用C++内建模块执行对应操作。在这个过程中，node底层会将传入的参数、执行的方法以及回调函数封装成一个FSReqWrap请求对象，将回调函数赋给oncomplete_sym属性上，并将其放入线程池等待执行。而此时JavaScript线程会继续执行后续操作。")]),s._v(" "),n("p",[n("strong",[s._v("执行回调")])]),s._v(" "),n("p",[s._v("当线程池中I/O操作完成，会将执行结果赋给result属性，同时会将该请求对象加入到I/O观察者队列中。在事件循环过程中，询问I/O观察者是否有事件待处理，如果存在，则取出请求对象中的result作为结果参数，oncomplete_sym属性作为回调执行。")]),s._v(" "),n("h2",{attrs:{id:"eventloop"}},[s._v("EventLoop "),n("a",{staticClass:"header-anchor",attrs:{href:"#eventloop"}},[s._v("#")])]),s._v(" "),n("h3",{attrs:{id:"nodejs-启动过程"}},[s._v("NodeJS 启动过程 "),n("a",{staticClass:"header-anchor",attrs:{href:"#nodejs-启动过程"}},[s._v("#")])]),s._v(" "),n("ol",[n("li",[s._v("调用 platformInit 方法，初始化 nodejs 的运行环境；")]),s._v(" "),n("li",[s._v("调用 performance_node_start 方法，对 nodejs 进行性能统计；")]),s._v(" "),n("li",[s._v("openssl 设置的判断；")]),s._v(" "),n("li",[s._v("调用 v8_platform.Initialize，初始化 libuv 线程池；")]),s._v(" "),n("li",[s._v("调用 V8::Initialize，初始化 V8 环境；")]),s._v(" "),n("li",[s._v("创建一个 nodejs 运行实例；")]),s._v(" "),n("li",[s._v("启动上一步创建好的实例；")]),s._v(" "),n("li",[s._v("开始执行 js 文件，同步代码执行完毕后，进入事件循环；")]),s._v(" "),n("li",[s._v("在没有任何可监听的事件时，销毁 nodejs 实例，程序执行完毕。")])]),s._v(" "),n("h3",{attrs:{id:"事件循环"}},[s._v("事件循环 "),n("a",{staticClass:"header-anchor",attrs:{href:"#事件循环"}},[s._v("#")])]),s._v(" "),n("p",[n("img",{attrs:{src:"node-eventloop.png",alt:"node-eventloop"}})]),s._v(" "),n("p",[s._v("NodeJS 的事件循环有 6 个阶段（6 类观察者）：")]),s._v(" "),n("ol",[n("li",[s._v("timers 阶段：执行 setTimeout 和 setInterval 中到期的 callback；")]),s._v(" "),n("li",[s._v("I/O(pending) callbacks 阶段：上一轮少数的 I/O callback 会延迟到这一阶段执行，这些事件有一个叫 pending 的双向链表维护；")]),s._v(" "),n("li",[s._v("idle，prepare 阶段：内部调用；")]),s._v(" "),n("li",[s._v("poll 阶段：最重要的阶段，执行 I/O callback；")]),s._v(" "),n("li",[s._v("check 阶段：执行 setImmediate 的 callback；")]),s._v(" "),n("li",[s._v("close 阶段：执行 close 事件的 callback。\nNodeJS 事件循环每个阶段完成后，就会执行微任务 microTask 队列（nextTick 和 Promise）。")])]),s._v(" "),n("h3",{attrs:{id:"process-nexttick-、promise、setimmediate"}},[s._v("process.nextTick 、Promise、setImmediate "),n("a",{staticClass:"header-anchor",attrs:{href:"#process-nexttick-、promise、setimmediate"}},[s._v("#")])]),s._v(" "),n("p",[s._v("在具体实现上，process.nextTick() 的回调函数保存在一个数组中，setImmediate() 的结果则是保存在链表中。")]),s._v(" "),n("p",[s._v("在行为上，process.nextTick() 在每轮循环中都会将数组中的回调函数全部执行完，而 setImmediate()  在每轮循环中执行链表中的一个回调函数。\nnextTick 和 Promise 都是微任务， 微任务 nextTick 优先级要比 Promise 要高。")]),s._v(" "),n("div",{staticClass:"language-js line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-js"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 微任务 nextTick 优先级要比 Promise 要高")]),s._v("\nPromise"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("resolve")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("then")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=>")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  console"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("log")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'promise 延迟执行1'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\nprocess"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("nextTick")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=>")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  console"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("log")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'nextTick 延迟执行1'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\nprocess"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("nextTick")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=>")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  console"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("log")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'nextTick 延迟执行2'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\n"),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("setImmediate")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=>")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  console"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("log")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'setImmediate 延迟执行1'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\n  "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 进入下一循环")]),s._v("\n  Promise"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("resolve")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("then")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=>")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    console"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("log")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'promise 延迟执行2'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\n  "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 进入下一循环")]),s._v("\n  process"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("nextTick")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=>")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    console"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("log")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'强势插入'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\n"),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("setImmediate")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=>")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  console"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("log")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'setImmediate 延迟执行2'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\nconsole"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("log")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'正常执行'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br"),n("span",{staticClass:"line-number"},[s._v("24")]),n("br"),n("span",{staticClass:"line-number"},[s._v("25")]),n("br"),n("span",{staticClass:"line-number"},[s._v("26")]),n("br"),n("span",{staticClass:"line-number"},[s._v("27")]),n("br"),n("span",{staticClass:"line-number"},[s._v("28")]),n("br"),n("span",{staticClass:"line-number"},[s._v("29")]),n("br"),n("span",{staticClass:"line-number"},[s._v("30")]),n("br"),n("span",{staticClass:"line-number"},[s._v("31")]),n("br"),n("span",{staticClass:"line-number"},[s._v("32")]),n("br")])]),n("p",[s._v("输出：")]),s._v(" "),n("div",{staticClass:"language-js line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-js"}},[n("code",[s._v("正常执行\nnextTick 延迟执行"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("\nnextTick 延迟执行"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v("\npromise 延迟执行"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("\nsetImmediate 延迟执行"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("\n强势插入\npromise 延迟执行"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v("\nsetImmediate 延迟执行"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br")])])])}),[],!1,null,null,null);t.default=e.exports}}]);